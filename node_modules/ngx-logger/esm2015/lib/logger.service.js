/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable } from '@angular/core';
import { HttpHeaders, HttpParams } from '@angular/common/http';
import { NGXLoggerHttpService } from './http.service';
import { NgxLoggerLevel } from './types/logger-level.enum';
import { LoggerConfig } from './logger.config';
import { NGXLoggerConfigEngine } from './config.engine';
import { NGXLoggerUtils } from './utils/logger.utils';
import { NGXMapperService } from './mapper.service';
/** @type {?} */
export const Levels = [
    'TRACE',
    'DEBUG',
    'INFO',
    'LOG',
    'WARN',
    'ERROR',
    'FATAL',
    'OFF'
];
export class NGXLogger {
    /**
     * @param {?} mapperService
     * @param {?} httpService
     * @param {?} loggerConfig
     */
    constructor(mapperService, httpService, loggerConfig) {
        this.mapperService = mapperService;
        this.httpService = httpService;
        this._withCredentials = false;
        this._isIE = navigator && navigator.userAgent &&
            !!(navigator.userAgent.indexOf('MSIE') !== -1 || navigator.userAgent.match(/Trident\//) || navigator.userAgent.match(/Edge\//));
        // each instance of the logger should have their own config engine
        this.config = new NGXLoggerConfigEngine(loggerConfig);
        this._logFunc = this._isIE ? this._logIE.bind(this) : this._logModern.bind(this);
    }
    /**
     * @param {?} message
     * @param {...?} additional
     * @return {?}
     */
    trace(message, ...additional) {
        this._log(NgxLoggerLevel.TRACE, message, additional);
    }
    /**
     * @param {?} message
     * @param {...?} additional
     * @return {?}
     */
    debug(message, ...additional) {
        this._log(NgxLoggerLevel.DEBUG, message, additional);
    }
    /**
     * @param {?} message
     * @param {...?} additional
     * @return {?}
     */
    info(message, ...additional) {
        this._log(NgxLoggerLevel.INFO, message, additional);
    }
    /**
     * @param {?} message
     * @param {...?} additional
     * @return {?}
     */
    log(message, ...additional) {
        this._log(NgxLoggerLevel.LOG, message, additional);
    }
    /**
     * @param {?} message
     * @param {...?} additional
     * @return {?}
     */
    warn(message, ...additional) {
        this._log(NgxLoggerLevel.WARN, message, additional);
    }
    /**
     * @param {?} message
     * @param {...?} additional
     * @return {?}
     */
    error(message, ...additional) {
        this._log(NgxLoggerLevel.ERROR, message, additional);
    }
    /**
     * @param {?} message
     * @param {...?} additional
     * @return {?}
     */
    fatal(message, ...additional) {
        this._log(NgxLoggerLevel.FATAL, message, additional);
    }
    /**
     * @param {?} headers
     * @return {?}
     */
    setCustomHttpHeaders(headers) {
        this._customHttpHeaders = headers;
    }
    /**
     * @param {?} params
     * @return {?}
     */
    setCustomParams(params) {
        this._customParams = params;
    }
    /**
     * @param {?} withCredentials
     * @return {?}
     */
    setWithCredentialsOptionValue(withCredentials) {
        this._withCredentials = withCredentials;
    }
    /**
     * @param {?} monitor
     * @return {?}
     */
    registerMonitor(monitor) {
        this._loggerMonitor = monitor;
    }
    /**
     * @param {?} config
     * @return {?}
     */
    updateConfig(config) {
        this.config.updateConfig(config);
    }
    /**
     * @return {?}
     */
    getConfigSnapshot() {
        return this.config.getConfig();
    }
    /**
     * @private
     * @param {?} level
     * @param {?} metaString
     * @param {?} message
     * @param {?} additional
     * @return {?}
     */
    _logIE(level, metaString, message, additional) {
        // Coloring doesn't work in IE
        // make sure additional isn't null or undefined so that ...additional doesn't error
        additional = additional || [];
        switch (level) {
            case NgxLoggerLevel.WARN:
                console.warn(`${metaString} `, message, ...additional);
                break;
            case NgxLoggerLevel.ERROR:
            case NgxLoggerLevel.FATAL:
                console.error(`${metaString} `, message, ...additional);
                break;
            case NgxLoggerLevel.INFO:
                console.info(`${metaString} `, message, ...additional);
                break;
            default:
                console.log(`${metaString} `, message, ...additional);
        }
    }
    /**
     * @private
     * @param {?} level
     * @param {?} metaString
     * @param {?} message
     * @param {?} additional
     * @return {?}
     */
    _logModern(level, metaString, message, additional) {
        /** @type {?} */
        const color = NGXLoggerUtils.getColor(level);
        // make sure additional isn't null or undefined so that ...additional doesn't error
        additional = additional || [];
        switch (level) {
            case NgxLoggerLevel.WARN:
                console.warn(`%c${metaString}`, `color:${color}`, message, ...additional);
                break;
            case NgxLoggerLevel.ERROR:
            case NgxLoggerLevel.FATAL:
                console.error(`%c${metaString}`, `color:${color}`, message, ...additional);
                break;
            case NgxLoggerLevel.INFO:
                console.info(`%c${metaString}`, `color:${color}`, message, ...additional);
                break;
            //  Disabling console.trace since the stack trace is not helpful. it is showing the stack trace of
            // the console.trace statement
            // case NgxLoggerLevel.TRACE:
            //   console.trace(`%c${metaString}`, `color:${color}`, message, ...additional);
            //   break;
            //  Disabling console.debug, because Has this hidden by default.
            // case NgxLoggerLevel.DEBUG:
            //   console.debug(`%c${metaString}`, `color:${color}`, message, ...additional);
            //   break;
            default:
                console.log(`%c${metaString}`, `color:${color}`, message, ...additional);
        }
    }
    /**
     * @private
     * @param {?} level
     * @param {?} message
     * @param {?=} additional
     * @param {?=} logOnServer
     * @return {?}
     */
    _log(level, message, additional = [], logOnServer = true) {
        /** @type {?} */
        const config = this.config.getConfig();
        /** @type {?} */
        const isLog2Server = logOnServer && config.serverLoggingUrl && level >= config.serverLogLevel;
        /** @type {?} */
        const isLogLevelEnabled = level >= config.level;
        if (!(message && (isLog2Server || isLogLevelEnabled))) {
            return;
        }
        /** @type {?} */
        const logLevelString = Levels[level];
        message = typeof message === 'function' ? message() : message;
        message = NGXLoggerUtils.prepareMessage(message);
        // only use validated parameters for HTTP requests
        /** @type {?} */
        const validatedAdditionalParameters = NGXLoggerUtils.prepareAdditionalParameters(additional);
        /** @type {?} */
        const timestamp = new Date().toISOString();
        // const callerDetails = NGXLoggerUtils.getCallerDetails();
        this.mapperService.getCallerDetails(config.enableSourceMaps).subscribe((/**
         * @param {?} callerDetails
         * @return {?}
         */
        (callerDetails) => {
            /** @type {?} */
            const logObject = {
                message: message,
                additional: validatedAdditionalParameters,
                level: level,
                timestamp: timestamp,
                fileName: callerDetails.fileName,
                lineNumber: callerDetails.lineNumber.toString()
            };
            if (this._loggerMonitor && isLogLevelEnabled) {
                this._loggerMonitor.onLog(logObject);
            }
            if (isLog2Server) {
                // make sure the stack gets sent to the server
                message = message instanceof Error ? message.stack : message;
                logObject.message = message;
                /** @type {?} */
                const headers = this._customHttpHeaders || new HttpHeaders();
                headers.set('Content-Type', 'application/json');
                /** @type {?} */
                const options = {
                    headers: headers,
                    params: this._customParams || new HttpParams(),
                    responseType: config.httpResponseType || 'json',
                    withCredentials: this._withCredentials
                };
                // Allow logging on server even if client log level is off
                this.httpService.logOnServer(config.serverLoggingUrl, logObject, options).subscribe((/**
                 * @param {?} res
                 * @return {?}
                 */
                (res) => {
                    // I don't think we should do anything on success
                }), (/**
                 * @param {?} error
                 * @return {?}
                 */
                (error) => {
                    this._log(NgxLoggerLevel.ERROR, `FAILED TO LOG ON SERVER: ${message}`, [error], false);
                }));
            }
            // if no message or the log level is less than the environ
            if (isLogLevelEnabled && !config.disableConsoleLogging) {
                /** @type {?} */
                const metaString = NGXLoggerUtils.prepareMetaString(timestamp, logLevelString, callerDetails.fileName, callerDetails.lineNumber.toString());
                return this._logFunc(level, metaString, message, additional);
            }
        }));
    }
}
NGXLogger.decorators = [
    { type: Injectable }
];
/** @nocollapse */
NGXLogger.ctorParameters = () => [
    { type: NGXMapperService },
    { type: NGXLoggerHttpService },
    { type: LoggerConfig }
];
if (false) {
    /**
     * @type {?}
     * @private
     */
    NGXLogger.prototype._isIE;
    /**
     * @type {?}
     * @private
     */
    NGXLogger.prototype._logFunc;
    /**
     * @type {?}
     * @private
     */
    NGXLogger.prototype.config;
    /**
     * @type {?}
     * @private
     */
    NGXLogger.prototype._customHttpHeaders;
    /**
     * @type {?}
     * @private
     */
    NGXLogger.prototype._customParams;
    /**
     * @type {?}
     * @private
     */
    NGXLogger.prototype._withCredentials;
    /**
     * @type {?}
     * @private
     */
    NGXLogger.prototype._loggerMonitor;
    /**
     * @type {?}
     * @private
     */
    NGXLogger.prototype.mapperService;
    /**
     * @type {?}
     * @private
     */
    NGXLogger.prototype.httpService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9nZ2VyLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZ3gtbG9nZ2VyLyIsInNvdXJjZXMiOlsibGliL2xvZ2dlci5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQVUsVUFBVSxFQUFlLE1BQU0sZUFBZSxDQUFDO0FBQ2hFLE9BQU8sRUFBcUIsV0FBVyxFQUFFLFVBQVUsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBR2xGLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRXRELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUMzRCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDL0MsT0FBTyxFQUFFLHFCQUFxQixFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDeEQsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBR3RELE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLGtCQUFrQixDQUFDOztBQUVwRCxNQUFNLE9BQU8sTUFBTSxHQUFHO0lBQ3BCLE9BQU87SUFDUCxPQUFPO0lBQ1AsTUFBTTtJQUNOLEtBQUs7SUFDTCxNQUFNO0lBQ04sT0FBTztJQUNQLE9BQU87SUFDUCxLQUFLO0NBQ047QUFJRCxNQUFNLE9BQU8sU0FBUzs7Ozs7O0lBVXBCLFlBQTZCLGFBQStCLEVBQW1CLFdBQWlDLEVBQ3BHLFlBQTBCO1FBRFQsa0JBQWEsR0FBYixhQUFhLENBQWtCO1FBQW1CLGdCQUFXLEdBQVgsV0FBVyxDQUFzQjtRQUp4RyxxQkFBZ0IsR0FBWSxLQUFLLENBQUM7UUFNeEMsSUFBSSxDQUFDLEtBQUssR0FBRyxTQUFTLElBQUksU0FBUyxDQUFDLFNBQVM7WUFDM0MsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLElBQUksU0FBUyxDQUFDLFNB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T1JNX0lEIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBIdHRwRXJyb3JSZXNwb25zZSwgSHR0cEhlYWRlcnMsIEh0dHBQYXJhbXMgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQgeyBpc1BsYXRmb3JtQnJvd3NlciB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XG5cbmltcG9ydCB7IE5HWExvZ2dlckh0dHBTZXJ2aWNlIH0gZnJvbSAnLi9odHRwLnNlcnZpY2UnO1xuaW1wb3J0IHtMb2dQb3NpdGlvbn0gZnJvbSAnLi90eXBlcy9sb2ctcG9zaXRpb24nO1xuaW1wb3J0IHsgTmd4TG9nZ2VyTGV2ZWwgfSBmcm9tICcuL3R5cGVzL2xvZ2dlci1sZXZlbC5lbnVtJztcbmltcG9ydCB7IExvZ2dlckNvbmZpZyB9IGZyb20gJy4vbG9nZ2VyLmNvbmZpZyc7XG5pbXBvcnQgeyBOR1hMb2dnZXJDb25maWdFbmdpbmUgfSBmcm9tICcuL2NvbmZpZy5lbmdpbmUnO1xuaW1wb3J0IHsgTkdYTG9nZ2VyVXRpbHMgfSBmcm9tICcuL3V0aWxzL2xvZ2dlci51dGlscyc7XG5pbXBvcnQgeyBOR1hMb2dnZXJNb25pdG9yIH0gZnJvbSAnLi9sb2dnZXItbW9uaXRvcic7XG5pbXBvcnQgeyBOR1hMb2dJbnRlcmZhY2UgfSBmcm9tICcuL3R5cGVzL25neC1sb2cuaW50ZXJmYWNlJztcbmltcG9ydCB7IE5HWE1hcHBlclNlcnZpY2UgfSBmcm9tICcuL21hcHBlci5zZXJ2aWNlJztcblxuZXhwb3J0IGNvbnN0IExldmVscyA9IFtcbiAgJ1RSQUNFJyxcbiAgJ0RFQlVHJyxcbiAgJ0lORk8nLFxuICAnTE9HJyxcbiAgJ1dBUk4nLFxuICAnRVJST1InLFxuICAnRkFUQUwnLFxuICAnT0ZGJ1xuXTtcblxuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgTkdYTG9nZ2VyIHtcbiAgcHJpdmF0ZSByZWFkb25seSBfaXNJRTogYm9vbGVhbjtcbiAgcHJpdmF0ZSByZWFkb25seSBfbG9nRnVuYzogRnVuY3Rpb247XG4gIHByaXZhdGUgY29uZmlnOiBOR1hMb2dnZXJDb25maWdFbmdpbmU7XG4gIHByaXZhdGUgX2N1c3RvbUh0dHBIZWFkZXJzOiBIdHRwSGVhZGVycztcbiAgcHJpdmF0ZSBfY3VzdG9tUGFyYW1zOiBIdHRwUGFyYW1zO1xuICBwcml2YXRlIF93aXRoQ3JlZGVudGlhbHM6IGJvb2xlYW4gPSBmYWxzZTtcblxuICBwcml2YXRlIF9sb2dnZXJNb25pdG9yOiBOR1hMb2dnZXJNb25pdG9yO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgbWFwcGVyU2VydmljZTogTkdYTWFwcGVyU2VydmljZSwgcHJpdmF0ZSByZWFkb25seSBodHRwU2VydmljZTogTkdYTG9nZ2VySHR0cFNlcnZpY2UsXG4gICAgICAgICAgICAgIGxvZ2dlckNvbmZpZzogTG9nZ2VyQ29uZmlnKSB7XG4gICAgdGhpcy5faXNJRSA9IG5hdmlnYXRvciAmJiBuYXZpZ2F0b3IudXNlckFnZW50ICYmXG4gICAgICAhIShuYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoJ01TSUUnKSAhPT0gLTEgfHwgbmF2aWdhdG9yLnVzZXJBZ2VudC5tYXRjaCgvVHJpZGVudFxcLy8pIHx8IG5hdmlnYXRvci51c2VyQWdlbnQubWF0Y2goL0VkZ2VcXC8vKSk7XG5cbiAgICAvLyBlYWNoIGluc3RhbmNlIG9mIHRoZSBsb2dnZXIgc2hvdWxkIGhhdmUgdGhlaXIgb3duIGNvbmZpZyBlbmdpbmVcbiAgICB0aGlzLmNvbmZpZyA9IG5ldyBOR1hMb2dnZXJDb25maWdFbmdpbmUobG9nZ2VyQ29uZmlnKTtcblxuICAgIHRoaXMuX2xvZ0Z1bmMgPSB0aGlzLl9pc0lFID8gdGhpcy5fbG9nSUUuYmluZCh0aGlzKSA6IHRoaXMuX2xvZ01vZGVybi5iaW5kKHRoaXMpO1xuXG4gIH1cblxuICBwdWJsaWMgdHJhY2UobWVzc2FnZSwgLi4uYWRkaXRpb25hbDogYW55W10pOiB2b2lkIHtcbiAgICB0aGlzLl9sb2coTmd4TG9nZ2VyTGV2ZWwuVFJBQ0UsIG1lc3NhZ2UsIGFkZGl0aW9uYWwpO1xuICB9XG5cbiAgcHVibGljIGRlYnVnKG1lc3NhZ2UsIC4uLmFkZGl0aW9uYWw6IGFueVtdKTogdm9pZCB7XG4gICAgdGhpcy5fbG9nKE5neExvZ2dlckxldmVsLkRFQlVHLCBtZXNzYWdlLCBhZGRpdGlvbmFsKTtcbiAgfVxuXG4gIHB1YmxpYyBpbmZvKG1lc3NhZ2UsIC4uLmFkZGl0aW9uYWw6IGFueVtdKTogdm9pZCB7XG4gICAgdGhpcy5fbG9nKE5neExvZ2dlckxldmVsLklORk8sIG1lc3NhZ2UsIGFkZGl0aW9uYWwpO1xuICB9XG5cbiAgcHVibGljIGxvZyhtZXNzYWdlLCAuLi5hZGRpdGlvbmFsOiBhbnlbXSk6IHZvaWQge1xuICAgIHRoaXMuX2xvZyhOZ3hMb2dnZXJMZXZlbC5MT0csIG1lc3NhZ2UsIGFkZGl0aW9uYWwpO1xuICB9XG5cbiAgcHVibGljIHdhcm4obWVzc2FnZSwgLi4uYWRkaXRpb25hbDogYW55W10pOiB2b2lkIHtcbiAgICB0aGlzLl9sb2coTmd4TG9nZ2VyTGV2ZWwuV0FSTiwgbWVzc2FnZSwgYWRkaXRpb25hbCk7XG4gIH1cblxuICBwdWJsaWMgZXJyb3IobWVzc2FnZSwgLi4uYWRkaXRpb25hbDogYW55W10pOiB2b2lkIHtcbiAgICB0aGlzLl9sb2coTmd4TG9nZ2VyTGV2ZWwuRVJST1IsIG1lc3NhZ2UsIGFkZGl0aW9uYWwpO1xuICB9XG5cbiAgcHVibGljIGZhdGFsKG1lc3NhZ2UsIC4uLmFkZGl0aW9uYWw6IGFueVtdKTogdm9pZCB7XG4gICAgdGhpcy5fbG9nKE5neExvZ2dlckxldmVsLkZBVEFMLCBtZXNzYWdlLCBhZGRpdGlvbmFsKTtcbiAgfVxuXG4gIHB1YmxpYyBzZXRDdXN0b21IdHRwSGVhZGVycyhoZWFkZXJzOiBIdHRwSGVhZGVycykge1xuICAgIHRoaXMuX2N1c3RvbUh0dHBIZWFkZXJzID0gaGVhZGVycztcbiAgfVxuXG4gIHB1YmxpYyBzZXRDdXN0b21QYXJhbXMocGFyYW1zOiBIdHRwUGFyYW1zKSB7XG4gICAgdGhpcy5fY3VzdG9tUGFyYW1zID0gcGFyYW1zO1xuICB9XG5cbiAgcHVibGljIHNldFdpdGhDcmVkZW50aWFsc09wdGlvblZhbHVlKHdpdGhDcmVkZW50aWFsczogYm9vbGVhbikge1xuICAgIHRoaXMuX3dpdGhDcmVkZW50aWFscyA9IHdpdGhDcmVkZW50aWFscztcbiAgfVxuXG4gIHB1YmxpYyByZWdpc3Rlck1vbml0b3IobW9uaXRvcjogTkdYTG9nZ2VyTW9uaXRvcikge1xuICAgIHRoaXMuX2xvZ2dlck1vbml0b3IgPSBtb25pdG9yO1xuICB9XG5cbiAgcHVibGljIHVwZGF0ZUNvbmZpZyhjb25maWc6IExvZ2dlckNvbmZpZykge1xuICAgIHRoaXMuY29uZmlnLnVwZGF0ZUNvbmZpZyhjb25maWcpO1xuICB9XG5cbiAgcHVibGljIGdldENvbmZpZ1NuYXBzaG90KCk6IExvZ2dlckNvbmZpZyB7XG4gICAgcmV0dXJuIHRoaXMuY29uZmlnLmdldENvbmZpZygpO1xuICB9XG5cbiAgcHJpdmF0ZSBfbG9nSUUobGV2ZWw6IE5neExvZ2dlckxldmVsLCBtZXRhU3RyaW5nOiBzdHJpbmcsIG1lc3NhZ2U6IHN0cmluZywgYWRkaXRpb25hbDogYW55W10pOiB2b2lkIHtcblxuICAgIC8vIENvbG9yaW5nIGRvZXNuJ3Qgd29yayBpbiBJRVxuICAgIC8vIG1ha2Ugc3VyZSBhZGRpdGlvbmFsIGlzbid0IG51bGwgb3IgdW5kZWZpbmVkIHNvIHRoYXQgLi4uYWRkaXRpb25hbCBkb2Vzbid0IGVycm9yXG4gICAgYWRkaXRpb25hbCA9IGFkZGl0aW9uYWwgfHwgW107XG5cbiAgICBzd2l0Y2ggKGxldmVsKSB7XG4gICAgICBjYXNlIE5neExvZ2dlckxldmVsLldBUk46XG4gICAgICAgIGNvbnNvbGUud2FybihgJHttZXRhU3RyaW5nfSBgLCBtZXNzYWdlLCAuLi5hZGRpdGlvbmFsKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIE5neExvZ2dlckxldmVsLkVSUk9SOlxuICAgICAgY2FzZSBOZ3hMb2dnZXJMZXZlbC5GQVRBTDpcbiAgICAgICAgY29uc29sZS5lcnJvcihgJHttZXRhU3RyaW5nfSBgLCBtZXNzYWdlLCAuLi5hZGRpdGlvbmFsKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIE5neExvZ2dlckxldmVsLklORk86XG4gICAgICAgIGNvbnNvbGUuaW5mbyhgJHttZXRhU3RyaW5nfSBgLCBtZXNzYWdlLCAuLi5hZGRpdGlvbmFsKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICBjb25zb2xlLmxvZyhgJHttZXRhU3RyaW5nfSBgLCBtZXNzYWdlLCAuLi5hZGRpdGlvbmFsKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIF9sb2dNb2Rlcm4obGV2ZWw6IE5neExvZ2dlckxldmVsLCBtZXRhU3RyaW5nOiBzdHJpbmcsIG1lc3NhZ2U6IHN0cmluZywgYWRkaXRpb25hbDogYW55W10pOiB2b2lkIHtcblxuICAgIGNvbnN0IGNvbG9yID0gTkdYTG9nZ2VyVXRpbHMuZ2V0Q29sb3IobGV2ZWwpO1xuXG4gICAgLy8gbWFrZSBzdXJlIGFkZGl0aW9uYWwgaXNuJ3QgbnVsbCBvciB1bmRlZmluZWQgc28gdGhhdCAuLi5hZGRpdGlvbmFsIGRvZXNuJ3QgZXJyb3JcbiAgICBhZGRpdGlvbmFsID0gYWRkaXRpb25hbCB8fCBbXTtcblxuICAgIHN3aXRjaCAobGV2ZWwpIHtcbiAgICAgIGNhc2UgTmd4TG9nZ2VyTGV2ZWwuV0FSTjpcbiAgICAgICAgY29uc29sZS53YXJuKGAlYyR7bWV0YVN0cmluZ31gLCBgY29sb3I6JHtjb2xvcn1gLCBtZXNzYWdlLCAuLi5hZGRpdGlvbmFsKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIE5neExvZ2dlckxldmVsLkVSUk9SOlxuICAgICAgY2FzZSBOZ3hMb2dnZXJMZXZlbC5GQVRBTDpcbiAgICAgICAgY29uc29sZS5lcnJvcihgJWMke21ldGFTdHJpbmd9YCwgYGNvbG9yOiR7Y29sb3J9YCwgbWVzc2FnZSwgLi4uYWRkaXRpb25hbCk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBOZ3hMb2dnZXJMZXZlbC5JTkZPOlxuICAgICAgICBjb25zb2xlLmluZm8oYCVjJHttZXRhU3RyaW5nfWAsIGBjb2xvcjoke2NvbG9yfWAsIG1lc3NhZ2UsIC4uLmFkZGl0aW9uYWwpO1xuICAgICAgICBicmVhaztcbiAgICAgIC8vICBEaXNhYmxpbmcgY29uc29sZS50cmFjZSBzaW5jZSB0aGUgc3RhY2sgdHJhY2UgaXMgbm90IGhlbHBmdWwuIGl0IGlzIHNob3dpbmcgdGhlIHN0YWNrIHRyYWNlIG9mXG4gICAgICAvLyB0aGUgY29uc29sZS50cmFjZSBzdGF0ZW1lbnRcbiAgICAgIC8vIGNhc2UgTmd4TG9nZ2VyTGV2ZWwuVFJBQ0U6XG4gICAgICAvLyAgIGNvbnNvbGUudHJhY2UoYCVjJHttZXRhU3RyaW5nfWAsIGBjb2xvcjoke2NvbG9yfWAsIG1lc3NhZ2UsIC4uLmFkZGl0aW9uYWwpO1xuICAgICAgLy8gICBicmVhaztcblxuICAgICAgLy8gIERpc2FibGluZyBjb25zb2xlLmRlYnVnLCBiZWNhdXNlIEhhcyB0aGlzIGhpZGRlbiBieSBkZWZhdWx0LlxuICAgICAgLy8gY2FzZSBOZ3hMb2dnZXJMZXZlbC5ERUJVRzpcbiAgICAgIC8vICAgY29uc29sZS5kZWJ1ZyhgJWMke21ldGFTdHJpbmd9YCwgYGNvbG9yOiR7Y29sb3J9YCwgbWVzc2FnZSwgLi4uYWRkaXRpb25hbCk7XG4gICAgICAvLyAgIGJyZWFrO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgY29uc29sZS5sb2coYCVjJHttZXRhU3RyaW5nfWAsIGBjb2xvcjoke2NvbG9yfWAsIG1lc3NhZ2UsIC4uLmFkZGl0aW9uYWwpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgX2xvZyhsZXZlbDogTmd4TG9nZ2VyTGV2ZWwsIG1lc3NhZ2UsIGFkZGl0aW9uYWw6IGFueVtdID0gW10sIGxvZ09uU2VydmVyOiBib29sZWFuID0gdHJ1ZSk6IHZvaWQge1xuICAgIGNvbnN0IGNvbmZpZyA9IHRoaXMuY29uZmlnLmdldENvbmZpZygpO1xuICAgIGNvbnN0IGlzTG9nMlNlcnZlciA9IGxvZ09uU2VydmVyICYmIGNvbmZpZy5zZXJ2ZXJMb2dnaW5nVXJsICYmIGxldmVsID49IGNvbmZpZy5zZXJ2ZXJMb2dMZXZlbDtcbiAgICBjb25zdCBpc0xvZ0xldmVsRW5hYmxlZCA9IGxldmVsID49IGNvbmZpZy5sZXZlbDtcblxuICAgIGlmICghKG1lc3NhZ2UgJiYgKGlzTG9nMlNlcnZlciB8fCBpc0xvZ0xldmVsRW5hYmxlZCkpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgbG9nTGV2ZWxTdHJpbmcgPSBMZXZlbHNbbGV2ZWxdO1xuXG4gICAgbWVzc2FnZSA9IHR5cGVvZiBtZXNzYWdlID09PSAnZnVuY3Rpb24nID8gbWVzc2FnZSgpIDogbWVzc2FnZTtcbiAgICBtZXNzYWdlID0gTkdYTG9nZ2VyVXRpbHMucHJlcGFyZU1lc3NhZ2UobWVzc2FnZSk7XG5cbiAgICAvLyBvbmx5IHVzZSB2YWxpZGF0ZWQgcGFyYW1ldGVycyBmb3IgSFRUUCByZXF1ZXN0c1xuICAgIGNvbnN0IHZhbGlkYXRlZEFkZGl0aW9uYWxQYXJhbWV0ZXJzID0gTkdYTG9nZ2VyVXRpbHMucHJlcGFyZUFkZGl0aW9uYWxQYXJhbWV0ZXJzKGFkZGl0aW9uYWwpO1xuXG4gICAgY29uc3QgdGltZXN0YW1wID0gbmV3IERhdGUoKS50b0lTT1N0cmluZygpO1xuXG4gICAgLy8gY29uc3QgY2FsbGVyRGV0YWlscyA9IE5HWExvZ2dlclV0aWxzLmdldENhbGxlckRldGFpbHMoKTtcbiAgICB0aGlzLm1hcHBlclNlcnZpY2UuZ2V0Q2FsbGVyRGV0YWlscyhjb25maWcuZW5hYmxlU291cmNlTWFwcykuc3Vic2NyaWJlKChjYWxsZXJEZXRhaWxzOiBMb2dQb3NpdGlvbikgPT4ge1xuICAgICAgY29uc3QgbG9nT2JqZWN0OiBOR1hMb2dJbnRlcmZhY2UgPSB7XG4gICAgICAgIG1lc3NhZ2U6IG1lc3NhZ2UsXG4gICAgICAgIGFkZGl0aW9uYWw6IHZhbGlkYXRlZEFkZGl0aW9uYWxQYXJhbWV0ZXJzLFxuICAgICAgICBsZXZlbDogbGV2ZWwsXG4gICAgICAgIHRpbWVzdGFtcDogdGltZXN0YW1wLFxuICAgICAgICBmaWxlTmFtZTogY2FsbGVyRGV0YWlscy5maWxlTmFtZSxcbiAgICAgICAgbGluZU51bWJlcjogY2FsbGVyRGV0YWlscy5saW5lTnVtYmVyLnRvU3RyaW5nKClcbiAgICAgIH07XG5cbiAgICAgIGlmICh0aGlzLl9sb2dnZXJNb25pdG9yICYmIGlzTG9nTGV2ZWxFbmFibGVkKSB7XG4gICAgICAgIHRoaXMuX2xvZ2dlck1vbml0b3Iub25Mb2cobG9nT2JqZWN0KTtcbiAgICAgIH1cblxuICAgICAgaWYgKGlzTG9nMlNlcnZlcikge1xuICAgICAgICAvLyBtYWtlIHN1cmUgdGhlIHN0YWNrIGdldHMgc2VudCB0byB0aGUgc2VydmVyXG4gICAgICAgIG1lc3NhZ2UgPSBtZXNzYWdlIGluc3RhbmNlb2YgRXJyb3IgPyBtZXNzYWdlLnN0YWNrIDogbWVzc2FnZTtcbiAgICAgICAgbG9nT2JqZWN0Lm1lc3NhZ2UgPSBtZXNzYWdlO1xuXG4gICAgICAgIGNvbnN0IGhlYWRlcnMgPSB0aGlzLl9jdXN0b21IdHRwSGVhZGVycyB8fCBuZXcgSHR0cEhlYWRlcnMoKTtcbiAgICAgICAgaGVhZGVycy5zZXQoJ0NvbnRlbnQtVHlwZScsICdhcHBsaWNhdGlvbi9qc29uJyk7XG5cbiAgICAgICAgY29uc3Qgb3B0aW9ucyA9IHtcbiAgICAgICAgICBoZWFkZXJzOiBoZWFkZXJzLFxuICAgICAgICAgIHBhcmFtczogdGhpcy5fY3VzdG9tUGFyYW1zIHx8IG5ldyBIdHRwUGFyYW1zKCksXG4gICAgICAgICAgcmVzcG9uc2VUeXBlOiBjb25maWcuaHR0cFJlc3BvbnNlVHlwZSB8fCAnanNvbicsXG4gICAgICAgICAgd2l0aENyZWRlbnRpYWxzOiB0aGlzLl93aXRoQ3JlZGVudGlhbHNcbiAgICAgICAgfTtcbiAgICAgICAgLy8gQWxsb3cgbG9nZ2luZyBvbiBzZXJ2ZXIgZXZlbiBpZiBjbGllbnQgbG9nIGxldmVsIGlzIG9mZlxuICAgICAgICB0aGlzLmh0dHBTZXJ2aWNlLmxvZ09uU2VydmVyKGNvbmZpZy5zZXJ2ZXJMb2dnaW5nVXJsLCBsb2dPYmplY3QsIG9wdGlvbnMpLnN1YnNjcmliZSgocmVzOiBhbnkpID0+IHtcbiAgICAgICAgICAgIC8vIEkgZG9uJ3QgdGhpbmsgd2Ugc2hvdWxkIGRvIGFueXRoaW5nIG9uIHN1Y2Nlc3NcbiAgICAgICAgICB9LFxuICAgICAgICAgIChlcnJvcjogSHR0cEVycm9yUmVzcG9uc2UpID0+IHtcbiAgICAgICAgICAgIHRoaXMuX2xvZyhOZ3hMb2dnZXJMZXZlbC5FUlJPUiwgYEZBSUxFRCBUTyBMT0cgT04gU0VSVkVSOiAke21lc3NhZ2V9YCwgW2Vycm9yXSwgZmFsc2UpO1xuICAgICAgICAgIH1cbiAgICAgICAgKTtcbiAgICAgIH1cblxuXG4gICAgICAvLyBpZiBubyBtZXNzYWdlIG9yIHRoZSBsb2cgbGV2ZWwgaXMgbGVzcyB0aGFuIHRoZSBlbnZpcm9uXG4gICAgICBpZiAoaXNMb2dMZXZlbEVuYWJsZWQgJiYgIWNvbmZpZy5kaXNhYmxlQ29uc29sZUxvZ2dpbmcpIHtcbiAgICAgICAgY29uc3QgbWV0YVN0cmluZyA9IE5HWExvZ2dlclV0aWxzLnByZXBhcmVNZXRhU3RyaW5nKHRpbWVzdGFtcCwgbG9nTGV2ZWxTdHJpbmcsXG4gICAgICAgICAgY2FsbGVyRGV0YWlscy5maWxlTmFtZSwgY2FsbGVyRGV0YWlscy5saW5lTnVtYmVyLnRvU3RyaW5nKCkpO1xuXG4gICAgICAgIHJldHVybiB0aGlzLl9sb2dGdW5jKGxldmVsLCBtZXRhU3RyaW5nLCBtZXNzYWdlLCBhZGRpdGlvbmFsKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxufVxuIl19